<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Graph Editor com Salvar e Salvar Como</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: #333;
            color: #fff;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            height: 40px;
            flex-shrink: 0;
        }

        header button {
            margin-right: 10px;
            background: #555;
            border: none;
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
        }

        header button:hover {
            background: #777;
        }

        #container {
            flex: 1;
            display: flex;
            height: calc(100% - 40px);
            position: relative;
            background: #fafafa;
        }

        #graph-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        svg#connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            /* atrás dos nós */
        }

        .node {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background-color: #a2d5f2;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: grab;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
            color: #222;
            z-index: 1;
            /* sobre as linhas */
            text-align: center;
            transition: box-shadow 0.2s ease;
        }

        .node.selected {
            box-shadow: 0 0 10px 4px #0078d7;
        }

        /* ID fora do círculo, centralizado em cima */
        .number-tag {
            position: absolute;
            top: -36px;
            /* acima do círculo */
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #444;
            background: white;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            line-height: 32px;
            cursor: text;
            user-select: text;
        }

        .node .title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .node .summary {
            font-size: 0.9rem;
            color: #444;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        #edit-panel {
            width: 350px;
            background: #fff;
            border-left: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
            display: none;
            flex-shrink: 0;
            overflow-y: auto;
        }

        #edit-panel h2 {
            margin-top: 0;
        }

        #edit-panel label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        #edit-panel input[type="text"],
        #edit-panel input[type="number"],
        #edit-panel textarea,
        #edit-panel input[type="color"] {
            width: 100%;
            box-sizing: border-box;
            margin-top: 4px;
            padding: 6px;
            font-size: 1rem;
        }

        #edit-panel textarea {
            resize: vertical;
            min-height: 80px;
        }

        #edit-panel button {
            margin-top: 15px;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
        }

        #edit-connections-list>div {
            display: flex;
            gap: 5px;
            margin-top: 6px;
            align-items: center;
        }

        #edit-connections-list input[type="number"] {
            width: 25%;
        }

        #edit-connections-list input[type="text"] {
            width: 45%;
        }

        #edit-connections-list input[type="color"] {
            width: 15%;
            padding: 0;
            height: 30px;
        }

        #edit-connections-list button.remove-conn-btn {
            width: 15%;
            background: #d9534f;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
        }

        #edit-connections-list button.remove-conn-btn:hover {
            background: #c9302c;
        }
    </style>
</head>

<body>

    <header>
        <button id="save-btn">Salvar</button>
        <button id="save-as-btn">Salvar Como</button>
        <button id="load-btn">Carregar</button>
        <button id="add-node-btn">Add Node</button>
    </header>

    <div id="container">
        <div id="graph-area"></div>
        <svg id="connections-svg"></svg>

        <div id="edit-panel">
            <h2>Editar Nó</h2>
            <form id="edit-form">
                <label for="edit-id">ID (único)</label>
                <input type="number" id="edit-id" min="1" required />

                <label for="edit-title">Título</label>
                <input type="text" id="edit-title" required />

                <label for="edit-content">Conteúdo</label>
                <textarea id="edit-content" rows="5" required></textarea>

                <label for="edit-color">Cor do Nó</label>
                <input type="color" id="edit-color" value="#a2d5f2" />

                <label>Conexões</label>
                <div id="edit-connections-list"></div>
                <button type="button" id="add-connection-btn">Adicionar Conexão</button>

                <button type="submit">Salvar</button>
                <button type="button" id="duplicate-node-btn"
                    style="background:#0078d7; color:#fff; margin-left: 10px;">Duplicar Nó</button>
                <button type="button" id="delete-node-btn"
                    style="background:#d9534f; color:#fff; margin-left: 10px;">Deletar Nó</button>
                <button type="button" id="cancel-edit">Cancelar</button>
                <input type="file" id="load-input" style="display:none" accept=".json" />
            </form>
        </div>
    </div>

    <script>
        let graphData = {
            nodes: [
                {
                    id: 1,
                    title: "Node 1",
                    content: "Detalhes do node 1.",
                    x: 100, y: 100,
                    color: "#a2d5f2",
                    connections: [
                        { targetId: 2, label: "Link 1-2", color: "#444" }
                    ]
                },
                {
                    id: 2,
                    title: "Node 2",
                    content: "Conteúdo do node 2.",
                    x: 350, y: 200,
                    color: "#f2a2a2",
                    connections: []
                }
            ]
        };

        const graphArea = document.getElementById('graph-area');
        const svg = document.getElementById('connections-svg');
        const editPanel = document.getElementById('edit-panel');
        const editForm = document.getElementById('edit-form');
        const connectionsList = document.getElementById('edit-connections-list');
        let selectedNode = null;

        document.getElementById('add-node-btn').addEventListener('click', () => {
            const newId = getNextId();
            const newNode = {
                id: newId,
                title: 'Novo Nodo',
                content: "Novo Conteúdo",
                x: 200 + Math.random() * 100,
                y: 200 + Math.random() * 100,
                color: "#f2a2a2",
                connections: []
            };
            graphData.nodes.push(newNode);
            renderGraph();
        });

        document.getElementById('add-connection-btn').onclick = () => {
            if (!selectedNode) return;
            selectedNode.connections.push({ targetId: getNextId(), label: '', color: '#444' });
            showEditPanel(selectedNode);
        };

        document.getElementById('duplicate-node-btn').onclick = () => {
            if (!selectedNode) return;
            const newId = getNextId();
            const newNode = {
                id: newId,
                title: selectedNode.title + ' (Cópia)',
                content: selectedNode.content,
                x: Math.min(graphArea.clientWidth - 140, selectedNode.x + 10),
                y: Math.min(graphArea.clientHeight - 140, selectedNode.y + 10),
                color: selectedNode.color,
                connections: selectedNode.connections.map(c => ({ ...c }))
            };
            graphData.nodes.push(newNode);
            renderGraph();
            selectNode(newId);
        };

        // Adicione esta função para deletar nó:
        document.getElementById('delete-node-btn').onclick = () => {
            if (!selectedNode) return;
            if (confirm(`Confirmar remoção do nó "${selectedNode.title}" (ID ${selectedNode.id})?`)) {
                // Remove o nó do grafo
                graphData.nodes = graphData.nodes.filter(n => n.id !== selectedNode.id);
                // Remove conexões que apontam para esse nó
                graphData.nodes.forEach(n => {
                    n.connections = n.connections.filter(c => c.targetId !== selectedNode.id);
                });
                hideEditPanel();
                renderGraph();
            }
        };

        function getNextId() {
            let id = 1;
            while (graphData.nodes.some(n => n.id === id)) id++;
            return id;
        }

        function createNodeElement(node) {
            const nodeEl = document.createElement('div');
            nodeEl.classList.add('node');
            nodeEl.style.backgroundColor = node.color;
            nodeEl.style.left = node.x + 'px';
            nodeEl.style.top = node.y + 'px';
            nodeEl.dataset.id = node.id;

            const numberTag = document.createElement('label');
            numberTag.classList.add('number-tag');
            numberTag.textContent = node.id;
            nodeEl.appendChild(numberTag);

            const titleEl = document.createElement('div');
            titleEl.className = 'title';
            titleEl.textContent = node.title;
            nodeEl.appendChild(titleEl);

            const summary = document.createElement('div');
            summary.className = 'summary';
            summary.textContent = node.content.length > 100 ? node.content.substring(0, 100) + '...' : node.content;
            nodeEl.appendChild(summary);

            nodeEl.addEventListener('click', e => {
                e.stopPropagation();
                selectNode(node.id);
            });

            let offsetX, offsetY, dragging = false;
            nodeEl.addEventListener('mousedown', e => {
                dragging = true;
                offsetX = e.clientX - nodeEl.offsetLeft;
                offsetY = e.clientY - nodeEl.offsetTop;
                nodeEl.style.cursor = 'grabbing';
                e.preventDefault();
            });
            window.addEventListener('mouseup', () => {
                dragging = false;
                nodeEl.style.cursor = 'grab';
            });
            window.addEventListener('mousemove', e => {
                if (!dragging) return;
                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;
                newX = Math.max(0, Math.min(graphArea.clientWidth - nodeEl.clientWidth, newX));
                newY = Math.max(0, Math.min(graphArea.clientHeight - nodeEl.clientHeight, newY));
                nodeEl.style.left = newX + 'px';
                nodeEl.style.top = newY + 'px';
                node.x = newX;
                node.y = newY;
                drawConnections();
            });

            return nodeEl;
        }

        function drawConnections() {
            while (svg.firstChild) svg.removeChild(svg.firstChild);

            // Definição do marcador de seta
            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
            marker.setAttribute("id", "arrow");
            marker.setAttribute("markerWidth", "10");
            marker.setAttribute("markerHeight", "10");
            marker.setAttribute("refX", "8");
            marker.setAttribute("refY", "5");
            marker.setAttribute("orient", "auto");
            marker.setAttribute("markerUnits", "strokeWidth");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M0,0 L10,5 L0,10 z");
            path.setAttribute("fill", "#444");
            marker.appendChild(path);
            defs.appendChild(marker);
            svg.appendChild(defs);

            const r = 70;

            graphData.nodes.forEach(n => {
                const fromEl = graphArea.querySelector(`.node[data-id='${n.id}']`);
                if (!fromEl) return;
                const fromRect = fromEl.getBoundingClientRect();
                const graphRect = graphArea.getBoundingClientRect();

                n.connections.forEach(conn => {
                    const toNode = graphData.nodes.find(nd => nd.id === conn.targetId);
                    if (!toNode) return;
                    const toEl = graphArea.querySelector(`.node[data-id='${toNode.id}']`);
                    if (!toEl) return;
                    const toRect = toEl.getBoundingClientRect();

                    const x1 = fromRect.left + fromRect.width / 2 - graphRect.left;
                    const y1 = fromRect.top + fromRect.height / 2 - graphRect.top;
                    const x2 = toRect.left + toRect.width / 2 - graphRect.left;
                    const y2 = toRect.top + toRect.height / 2 - graphRect.top;

                    const dx = x2 - x1;
                    const dy = y2 - y1;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist === 0) return;

                    const startX = x1 + (dx / dist) * r;
                    const startY = y1 + (dy / dist) * r;
                    const endX = x2 - (dx / dist) * r;
                    const endY = y2 - (dy / dist) * r;

                    // Linha
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", startX);
                    line.setAttribute("y1", startY);
                    line.setAttribute("x2", endX);
                    line.setAttribute("y2", endY);
                    line.setAttribute("stroke", conn.color || "#444");
                    line.setAttribute("stroke-width", "3");
                    line.setAttribute("stroke-linecap", "round");
                    line.setAttribute("marker-end", "url(#arrow)");
                    svg.appendChild(line);

                    // Texto no meio da linha
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    const midX = (startX + endX) / 2;
                    const midY = (startY + endY) / 2;
                    text.setAttribute("x", midX);
                    text.setAttribute("y", midY - 10);
                    text.setAttribute("fill", conn.color || "#444");
                    text.setAttribute("font-size", "14");
                    text.setAttribute("font-family", "Arial, sans-serif");
                    text.setAttribute("text-anchor", "middle");
                    text.textContent = conn.label || "";
                    svg.appendChild(text);
                });
            });
        }

        function renderGraph() {
            graphArea.innerHTML = '';
            graphData.nodes.forEach(node => {
                const nodeEl = createNodeElement(node);
                if (selectedNode && node.id === selectedNode.id) {
                    nodeEl.classList.add('selected');
                }
                graphArea.appendChild(nodeEl);
            });
            drawConnections();
        }

        function selectNode(id) {
            selectedNode = graphData.nodes.find(n => n.id === id);
            if (!selectedNode) {
                hideEditPanel();
                return;
            }
            showEditPanel(selectedNode);
            renderGraph();
        }

        function showEditPanel(node) {
            editPanel.style.display = 'block';
            document.getElementById('edit-id').value = node.id;
            document.getElementById('edit-title').value = node.title;
            document.getElementById('edit-content').value = node.content;
            document.getElementById('edit-color').value = node.color || "#a2d5f2";

            // Limpa conexões
            connectionsList.innerHTML = '';

            node.connections.forEach((conn, idx) => {
                const div = document.createElement('div');

                // Target ID
                const targetInput = document.createElement('input');
                targetInput.type = 'number';
                targetInput.min = 1;
                targetInput.value = conn.targetId;
                targetInput.title = 'ID do Nó Alvo';
                targetInput.addEventListener('change', () => {
                    const val = parseInt(targetInput.value);
                    if (isNaN(val) || val < 1 || val === node.id || !graphData.nodes.some(n => n.id === val)) {
                        alert('ID alvo inválido');
                        targetInput.value = conn.targetId;
                        return;
                    }
                    conn.targetId = val;
                    renderGraph();
                });
                div.appendChild(targetInput);

                // Label texto
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.placeholder = 'Texto da conexão';
                labelInput.value = conn.label || '';
                labelInput.addEventListener('input', () => {
                    conn.label = labelInput.value;
                    renderGraph();
                });
                div.appendChild(labelInput);

                // Cor da linha
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = conn.color || '#444';
                colorInput.title = 'Cor da conexão';
                colorInput.addEventListener('change', () => {
                    conn.color = colorInput.value;
                    renderGraph();
                });
                div.appendChild(colorInput);

                // Botão remover conexão
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'X';
                removeBtn.classList.add('remove-conn-btn');
                removeBtn.title = 'Remover conexão';
                removeBtn.addEventListener('click', () => {
                    node.connections.splice(idx, 1);
                    showEditPanel(node);
                    renderGraph();
                });
                div.appendChild(removeBtn);

                connectionsList.appendChild(div);
            });
        }

        function hideEditPanel() {
            selectedNode = null;
            editPanel.style.display = 'none';
            renderGraph();
        }

        editForm.addEventListener('submit', e => {
            e.preventDefault();
            if (!selectedNode) return;

            const newId = parseInt(document.getElementById('edit-id').value);
            if (isNaN(newId) || newId < 1) {
                alert("ID deve ser um número válido e maior que zero");
                return;
            }
            if (graphData.nodes.some(n => n.id === newId && n !== selectedNode)) {
                alert("ID deve ser único");
                return;
            }

            // Atualiza conexões: valida IDs e atualiza para números válidos
            for (const conn of selectedNode.connections) {
                if (typeof conn.targetId !== 'number' || conn.targetId < 1 || !graphData.nodes.some(n => n.id === conn.targetId)) {
                    alert('Alguma conexão possui ID alvo inválido.');
                    return;
                }
            }

            const oldId = selectedNode.id;
            selectedNode.id = newId;
            selectedNode.title = document.getElementById('edit-title').value.trim();
            selectedNode.content = document.getElementById('edit-content').value.trim();
            selectedNode.color = document.getElementById('edit-color').value;

            // Atualiza conexões que referenciam o antigo id
            if (oldId !== newId) {
                graphData.nodes.forEach(n => {
                    n.connections.forEach(c => {
                        if (c.targetId === oldId) c.targetId = newId;
                    });
                });
            }

            hideEditPanel();
        });

        document.getElementById('cancel-edit').addEventListener('click', e => {
            e.preventDefault();
            hideEditPanel();
        });

        // Desselecionar ao clicar fora
        graphArea.addEventListener('click', () => {
            hideEditPanel();
        });

        // Salvar arquivo JSON
        document.getElementById('save-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(graphData, null, 2);
            download('graph.json', dataStr);
        });

        // Salvar Como
        document.getElementById('save-as-btn').addEventListener('click', () => {
            let filename = prompt('Digite o nome do arquivo (sem extensão)', 'graph');
            if (!filename) return;
            if (!filename.toLowerCase().endsWith('.json')) filename += '.json';
            const dataStr = JSON.stringify(graphData, null, 2);
            download(filename, dataStr);
        });

        function download(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Carregar JSON do arquivo
        document.getElementById('load-btn').addEventListener('click', () => {
            document.getElementById('load-input').click();
        });

        document.getElementById('load-input').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (loadedData.nodes && Array.isArray(loadedData.nodes)) {
                        graphData = loadedData;
                        hideEditPanel();
                        renderGraph();
                    } else {
                        alert('Arquivo JSON inválido.');
                    }
                } catch {
                    alert('Erro ao carregar JSON.');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' && selectedNode) {
                if (confirm(`Confirmar remoção do nó "${selectedNode.title}" (ID ${selectedNode.id})?`)) {
                    // Remove o nó do grafo
                    graphData.nodes = graphData.nodes.filter(n => n.id !== selectedNode.id);
                    // Remove conexões que apontam para esse nó
                    graphData.nodes.forEach(n => {
                        n.connections = n.connections.filter(c => c.targetId !== selectedNode.id);
                    });
                    hideEditPanel();
                    renderGraph();
                }
            }
        });


        // Inicializa
        renderGraph();
    </script>

</body>

</html>