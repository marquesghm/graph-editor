<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Graph Editor com Salvar e Salvar Como</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: #333;
            color: #fff;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            height: 40px;
            flex-shrink: 0;
        }

        header button {
            margin-right: 10px;
            background: #555;
            border: none;
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
        }

        header button:hover {
            background: #777;
        }

        #container {
            flex: 1;
            display: flex;
            height: calc(100% - 40px);
            position: relative;
            background: #fafafa;
        }

        #graph-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        svg#connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .node {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background-color: #a2d5f2;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: grab;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
            color: #222;
            z-index: 1;
            text-align: center;
            transition: box-shadow 0.2s ease;
        }

        .node.selected {
            box-shadow: 0 0 10px 4px #0078d7;
        }

        .number-tag {
            position: absolute;
            top: -36px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #444;
            background: white;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            line-height: 32px;
            cursor: text;
            user-select: text;
        }

        .node .title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .node .summary {
            font-size: 0.9rem;
            color: #444;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        #edit-panel {
            width: 350px;
            background: #fff;
            border-left: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
            display: none;
            flex-shrink: 0;
            overflow-y: auto;
        }

        #edit-panel h2 {
            margin-top: 0;
        }

        #edit-panel label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        #edit-panel input[type="text"],
        #edit-panel input[type="number"],
        #edit-panel textarea,
        #edit-panel input[type="color"] {
            width: 100%;
            box-sizing: border-box;
            margin-top: 4px;
            padding: 6px;
            font-size: 1rem;
        }

        #edit-panel textarea {
            resize: vertical;
            min-height: 80px;
        }

        #edit-panel button {
            margin-top: 15px;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
        }

        #edit-connections-list>div {
            display: flex;
            gap: 5px;
            margin-top: 6px;
            align-items: center;
        }

        #edit-connections-list input[type="number"] {
            width: 25%;
        }

        #edit-connections-list input[type="text"] {
            width: 45%;
        }

        #edit-connections-list input[type="color"] {
            width: 15%;
            padding: 0;
            height: 30px;
        }

        #edit-connections-list button.remove-conn-btn {
            width: 15%;
            background: #d9534f;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
        }

        #edit-connections-list button.remove-conn-btn:hover {
            background: #c9302c;
        }
    </style>
</head>

<body>

    <header>
        <button id="save-btn">Salvar</button>
        <button id="save-as-btn">Salvar Como</button>
        <button id="load-btn">Carregar</button>
        <button id="add-node-btn">Add Node</button>
    </header>

    <div id="container">
        <div id="graph-area"></div>
        <svg id="connections-svg"></svg>

        <div id="edit-panel">
            <h2>Editar Nó</h2>
            <form id="edit-form">
                <label for="edit-id">ID (único)</label>
                <input type="number" id="edit-id" min="1" required />

                <label for="edit-title">Título</label>
                <input type="text" id="edit-title" required />

                <label for="edit-content">Conteúdo</label>
                <textarea id="edit-content" rows="5" required></textarea>

                <label for="edit-color">Cor do Nó</label>
                <input type="color" id="edit-color" value="#a2d5f2" />

                <label>Conexões</label>
                <div id="edit-connections-list"></div>
                <button type="button" id="add-connection-btn">Adicionar Conexão</button>

                <label for="edit-photo">Foto do Nó</label>
                <input type="file" id="edit-photo" accept="image/*" />
                <img id="photo-preview" src="" alt="Prévia da foto"
                    style="display:none;max-width:100%;margin-top:8px;" />

                <div id="photo-size-group" style="display:none; margin-top:10px;">
                    <label for="photo-size-range">Tamanho da Foto (%)</label>
                    <input type="range" id="photo-size-range" min="40" max="100" value="80" />
                </div>
                <div id="photo-hide-group" style="display:none; margin-top:10px;">
                    <label>
                        <input type="checkbox" id="photo-hide-checkbox" />
                        Esconder conteúdo do nó (ID, título, texto)
                    </label>
                </div>
                <div id="node-size-group" style="display:none; margin-top:10px;">
                    <label for="node-size-input">Tamanho do Nó (px)</label>
                    <input type="number" id="node-size-input" min="40" max="400" value="140" />
                </div>

                <button type="submit">Salvar</button>
                <button type="button" id="duplicate-node-btn"
                    style="background:#0078d7; color:#fff; margin-left: 10px;">Duplicar Nó</button>
                <button type="button" id="delete-node-btn"
                    style="background:#d9534f; color:#fff; margin-left: 10px;">Deletar Nó</button>
                <button type="button" id="cancel-edit">Cancelar</button>
                <input type="file" id="load-input" style="display:none" accept=".json" />
            </form>
        </div>
    </div>

    <script>
        // Inicialize todos os elementos DOM antes de qualquer uso!
        const graphArea = document.getElementById('graph-area');
        const svg = document.getElementById('connections-svg');
        const editPanel = document.getElementById('edit-panel');
        const editForm = document.getElementById('edit-form');
        const connectionsList = document.getElementById('edit-connections-list');
        const photoInput = document.getElementById('edit-photo');
        const photoPreview = document.getElementById('photo-preview');
        const photoSizeGroup = document.getElementById('photo-size-group');
        const photoSizeRange = document.getElementById('photo-size-range');
        const photoHideGroup = document.getElementById('photo-hide-group');
        const photoHideCheckbox = document.getElementById('photo-hide-checkbox');
        const nodeSizeGroup = document.getElementById('node-size-group');
        const nodeSizeInput = document.getElementById('node-size-input');

        let graphData = {
            nodes: [
                {
                    id: 1,
                    title: "Node 1",
                    content: "Detalhes do node 1.",
                    x: 100, y: 100,
                    color: "#a2d5f2",
                    connections: [
                        { targetId: 2, label: "Link 1-2", color: "#444" }
                    ]
                },
                {
                    id: 2,
                    title: "Node 2",
                    content: "Conteúdo do node 2.",
                    x: 350, y: 200,
                    color: "#f2a2a2",
                    connections: []
                }
            ]
        };
        let selectedNode = null;

        document.getElementById('add-node-btn').addEventListener('click', () => {
            const newId = getNextId();
            const newNode = {
                id: newId,
                title: 'Novo Nodo',
                content: "Novo Conteúdo",
                x: 200 + Math.random() * 100,
                y: 200 + Math.random() * 100,
                color: "#f2a2a2",
                connections: []
            };
            graphData.nodes.push(newNode);
            renderGraph();
        });

        document.getElementById('add-connection-btn').onclick = () => {
            if (!selectedNode) return;
            selectedNode.connections.push({ targetId: getNextId(), label: '', color: '#444' });
            showEditPanel(selectedNode);
        };

        document.getElementById('duplicate-node-btn').onclick = () => {
            if (!selectedNode) return;
            const newId = getNextId();
            const newNode = {
                id: newId,
                title: selectedNode.title + ' (Cópia)',
                content: selectedNode.content,
                x: Math.min(graphArea.clientWidth - 140, selectedNode.x + 10),
                y: Math.min(graphArea.clientHeight - 140, selectedNode.y + 10),
                color: selectedNode.color,
                connections: selectedNode.connections.map(c => ({ ...c }))
            };
            graphData.nodes.push(newNode);
            renderGraph();
            selectNode(newId);
        };

        document.getElementById('delete-node-btn').onclick = () => {
            if (!selectedNode) return;
            if (confirm(`Confirmar remoção do nó "${selectedNode.title}" (ID ${selectedNode.id})?`)) {
                graphData.nodes = graphData.nodes.filter(n => n.id !== selectedNode.id);
                graphData.nodes.forEach(n => {
                    n.connections = n.connections.filter(c => c.targetId !== selectedNode.id);
                });
                hideEditPanel();
                renderGraph();
            }
        };

        function getNextId() {
            let id = 1;
            while (graphData.nodes.some(n => n.id === id)) id++;
            return id;
        }

        function createNodeElement(node) {
            const nodeEl = document.createElement('div');
            nodeEl.classList.add('node');
            nodeEl.style.left = node.x + 'px';
            nodeEl.style.top = node.y + 'px';
            nodeEl.dataset.id = node.id;

            if (node.photo) {
                nodeEl.innerHTML = '';

                // Tamanho base do nó
                const baseSize = node.nodeSize || 140;
                nodeEl.style.width = baseSize + 'px';
                nodeEl.style.height = baseSize + 'px';
                nodeEl.style.border = '2px solid #444';
                nodeEl.style.background = 'none';
                nodeEl.style.backgroundColor = 'transparent';
                nodeEl.style.overflow = 'hidden';
                nodeEl.style.display = 'flex';
                nodeEl.style.flexDirection = 'column';
                nodeEl.style.alignItems = 'center';
                nodeEl.style.justifyContent = 'flex-start';
                nodeEl.style.borderRadius = '16px';
                nodeEl.style.padding = '0';

                // Conteúdo do nó (ID, título, texto) acima da imagem, se não estiver oculto
                if (!node.hideContent) {
                    const numberTag = document.createElement('label');
                    numberTag.classList.add('number-tag');
                    numberTag.textContent = node.id;
                    numberTag.style.position = 'static';
                    numberTag.style.transform = 'none';
                    numberTag.style.margin = '8px auto 0 auto';
                    numberTag.style.display = 'block';
                    nodeEl.appendChild(numberTag);

                    const titleEl = document.createElement('div');
                    titleEl.className = 'title';
                    titleEl.textContent = node.title;
                    titleEl.style.margin = '4px 0 2px 0';
                    nodeEl.appendChild(titleEl);

                    const summary = document.createElement('div');
                    summary.className = 'summary';
                    summary.textContent = node.content.length > 100 ? node.content.substring(0, 100) + '...' : node.content;
                    summary.style.marginBottom = '4px';
                    nodeEl.appendChild(summary);
                }

                // Imagem ocupa o restante do nó
                const img = document.createElement('img');
                img.src = node.photo;
                img.alt = 'Foto do nó';
                img.style.objectFit = 'cover';
                img.style.width = (node.photoSize || 80) + '%';
                img.style.height = (node.photoSize || 80) + '%';
                img.style.margin = 'auto';
                img.style.display = 'block';
                img.style.flex = '1 1 auto';
                img.style.borderRadius = '8px';

                // Ajusta proporção do nó conforme a imagem
                img.onload = function () {
                    const aspect = img.naturalWidth / img.naturalHeight;
                    let width = baseSize, height = baseSize;
                    if (aspect > 1) {
                        width = baseSize;
                        height = Math.round(baseSize / aspect);
                    } else {
                        height = baseSize;
                        width = Math.round(baseSize * aspect);
                    }
                    nodeEl.style.width = width + 'px';
                    nodeEl.style.height = height + (node.hideContent ? 0 : 60) + 'px';
                };
                if (img.complete && img.naturalWidth) img.onload();

                nodeEl.appendChild(img);
            } else {
                nodeEl.style.backgroundColor = node.color;
                nodeEl.style.backgroundImage = '';
                nodeEl.style.border = '';
                nodeEl.style.borderRadius = '50%';
                nodeEl.style.overflow = 'visible';
                nodeEl.style.display = 'flex';

                const numberTag = document.createElement('label');
                numberTag.classList.add('number-tag');
                numberTag.textContent = node.id;
                nodeEl.appendChild(numberTag);

                const titleEl = document.createElement('div');
                titleEl.className = 'title';
                titleEl.textContent = node.title;
                nodeEl.appendChild(titleEl);

                const summary = document.createElement('div');
                summary.className = 'summary';
                summary.textContent = node.content.length > 100 ? node.content.substring(0, 100) + '...' : node.content;
                nodeEl.appendChild(summary);
            }

            nodeEl.addEventListener('click', e => {
                e.stopPropagation();
                selectNode(node.id);
            });

            let offsetX, offsetY, dragging = false;
            nodeEl.addEventListener('mousedown', e => {
                dragging = true;
                offsetX = e.clientX - nodeEl.offsetLeft;
                offsetY = e.clientY - nodeEl.offsetTop;
                nodeEl.style.cursor = 'grabbing';
                e.preventDefault();
            });
            window.addEventListener('mouseup', () => {
                dragging = false;
                nodeEl.style.cursor = 'grab';
            });
            window.addEventListener('mousemove', e => {
                if (!dragging) return;
                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;
                newX = Math.max(0, Math.min(graphArea.clientWidth - nodeEl.clientWidth, newX));
                newY = Math.max(0, Math.min(graphArea.clientHeight - nodeEl.clientHeight, newY));
                nodeEl.style.left = newX + 'px';
                nodeEl.style.top = newY + 'px';
                node.x = newX;
                node.y = newY;
                drawConnections();
            });

            return nodeEl;
        }

        function applyTransform() {
            // Aplica zoom e pan em tudo, inclusive nas linhas
            graphArea.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
            svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
            drawConnections();
        }

        function drawConnections() {
            while (svg.firstChild) svg.removeChild(svg.firstChild);

            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
            marker.setAttribute("id", "arrow");
            marker.setAttribute("markerWidth", "10");
            marker.setAttribute("markerHeight", "10");
            marker.setAttribute("refX", "8");
            marker.setAttribute("refY", "5");
            marker.setAttribute("orient", "auto");
            marker.setAttribute("markerUnits", "strokeWidth");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M0,0 L10,5 L0,10 z");
            path.setAttribute("fill", "#444");
            marker.appendChild(path);
            defs.appendChild(marker);
            svg.appendChild(defs);

            graphData.nodes.forEach(n => {
                const fromX = n.x + 70;
                const fromY = n.y + 70;

                n.connections.forEach(conn => {
                    const toNode = graphData.nodes.find(nd => nd.id === conn.targetId);
                    if (!toNode) return;

                    const toX = toNode.x + 70;
                    const toY = toNode.y + 70;

                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", fromX);
                    line.setAttribute("y1", fromY);
                    line.setAttribute("x2", toX);
                    line.setAttribute("y2", toY);
                    line.setAttribute("stroke", conn.color || "#444");
                    line.setAttribute("stroke-width", "3");
                    line.setAttribute("stroke-linecap", "round");
                    svg.appendChild(line);

                    const arrowLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    arrowLine.setAttribute("x1", fromX);
                    arrowLine.setAttribute("y1", fromY);
                    arrowLine.setAttribute("x2", toX);
                    arrowLine.setAttribute("y2", toY);
                    arrowLine.setAttribute("stroke", "none");
                    arrowLine.setAttribute("marker-end", "url(#arrow)");
                    svg.appendChild(arrowLine);

                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", (fromX + toX) / 2);
                    text.setAttribute("y", (fromY + toY) / 2 - 10);
                    text.setAttribute("fill", conn.color || "#444");
                    text.setAttribute("font-size", "14");
                    text.setAttribute("font-family", "Arial, sans-serif");
                    text.setAttribute("text-anchor", "middle");
                    text.textContent = conn.label || "";
                    svg.appendChild(text);
                });
            });
        }



        function renderGraph() {
            graphArea.innerHTML = '';
            graphData.nodes.forEach(node => {
                const nodeEl = createNodeElement(node);
                if (selectedNode && node.id === selectedNode.id) {
                    nodeEl.classList.add('selected');
                }
                graphArea.appendChild(nodeEl);
            });
            drawConnections();
        }

        function selectNode(id) {
            selectedNode = graphData.nodes.find(n => n.id === id);
            if (!selectedNode) {
                hideEditPanel();
                return;
            }
            showEditPanel(selectedNode);
            renderGraph();
        }

        function showEditPanel(node) {
            editPanel.style.display = 'block';
            document.getElementById('edit-id').value = node.id;
            document.getElementById('edit-title').value = node.title;
            document.getElementById('edit-content').value = node.content;
            document.getElementById('edit-color').value = node.color || "#a2d5f2";

            connectionsList.innerHTML = '';

            node.connections.forEach((conn, idx) => {
                const div = document.createElement('div');

                const targetInput = document.createElement('input');
                targetInput.type = 'number';
                targetInput.min = 1;
                targetInput.value = conn.targetId;
                targetInput.title = 'ID do Nó Alvo';
                targetInput.addEventListener('change', () => {
                    const val = parseInt(targetInput.value);
                    if (isNaN(val) || val < 1 || val === node.id || !graphData.nodes.some(n => n.id === val)) {
                        alert('ID alvo inválido');
                        targetInput.value = conn.targetId;
                        return;
                    }
                    conn.targetId = val;
                    renderGraph();
                });
                div.appendChild(targetInput);

                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.placeholder = 'Texto da conexão';
                labelInput.value = conn.label || '';
                labelInput.addEventListener('input', () => {
                    conn.label = labelInput.value;
                    renderGraph();
                });
                div.appendChild(labelInput);

                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = conn.color || '#444';
                colorInput.title = 'Cor da conexão';
                colorInput.addEventListener('change', () => {
                    conn.color = colorInput.value;
                    renderGraph();
                });
                div.appendChild(colorInput);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'X';
                removeBtn.classList.add('remove-conn-btn');
                removeBtn.title = 'Remover conexão';
                removeBtn.addEventListener('click', () => {
                    node.connections.splice(idx, 1);
                    showEditPanel(node);
                    renderGraph();
                });
                div.appendChild(removeBtn);

                connectionsList.appendChild(div);
            });

            if (node.photo) {
                photoPreview.src = node.photo;
                photoPreview.style.display = 'block';
                photoSizeGroup.style.display = 'block';
                photoSizeRange.value = node.photoSize || 80;
                nodeSizeGroup.style.display = 'block';
                nodeSizeInput.value = node.nodeSize || 140;
                photoHideGroup.style.display = 'block';
                photoHideCheckbox.checked = !!node.hideContent;
            } else {
                photoPreview.src = '';
                photoPreview.style.display = 'none';
                photoSizeGroup.style.display = 'none';
                nodeSizeGroup.style.display = 'none';
                photoHideGroup.style.display = 'none';
            }
            photoInput.value = '';
        }

        photoHideCheckbox.addEventListener('change', function () {
            if (selectedNode && selectedNode.photo) {
                selectedNode.hideContent = this.checked;
                renderGraph();
            }
        });

        function hideEditPanel() {
            selectedNode = null;
            editPanel.style.display = 'none';
            renderGraph();
        }

        editForm.addEventListener('submit', e => {
            e.preventDefault();
            if (!selectedNode) return;

            const newId = parseInt(document.getElementById('edit-id').value);
            if (isNaN(newId) || newId < 1) {
                alert("ID deve ser um número válido e maior que zero");
                return;
            }
            if (graphData.nodes.some(n => n.id === newId && n !== selectedNode)) {
                alert("ID deve ser único");
                return;
            }

            for (const conn of selectedNode.connections) {
                if (typeof conn.targetId !== 'number' || conn.targetId < 1 || !graphData.nodes.some(n => n.id === conn.targetId)) {
                    alert('Alguma conexão possui ID alvo inválido.');
                    return;
                }
            }

            const oldId = selectedNode.id;
            selectedNode.id = newId;
            selectedNode.title = document.getElementById('edit-title').value.trim();
            selectedNode.content = document.getElementById('edit-content').value.trim();
            selectedNode.color = document.getElementById('edit-color').value;

            if (oldId !== newId) {
                graphData.nodes.forEach(n => {
                    n.connections.forEach(c => {
                        if (c.targetId === oldId) c.targetId = newId;
                    });
                });
            }

            hideEditPanel();
        });

        document.getElementById('cancel-edit').addEventListener('click', e => {
            e.preventDefault();
            hideEditPanel();
        });

        graphArea.addEventListener('click', () => {
            hideEditPanel();
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(graphData, null, 2);
            download('graph.json', dataStr);
        });

        document.getElementById('save-as-btn').addEventListener('click', () => {
            let filename = prompt('Digite o nome do arquivo (sem extensão)', 'graph');
            if (!filename) return;
            if (!filename.toLowerCase().endsWith('.json')) filename += '.json';
            const dataStr = JSON.stringify(graphData, null, 2);
            download(filename, dataStr);
        });

        // download com zoom e pan
        function download(filename, text) {
            const data = {
                ...JSON.parse(text),
                __zoom: zoom,
                __translateX: translateX,
                __translateY: translateY
            };
            const element = document.createElement('a');
            element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 2)));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        document.getElementById('load-btn').addEventListener('click', () => {
            document.getElementById('load-input').click();
        });

        document.getElementById('load-input').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (loadedData.nodes && Array.isArray(loadedData.nodes)) {
                        graphData = loadedData;
                        zoom = loadedData.__zoom || 1;
                        translateX = loadedData.__translateX || 0;
                        translateY = loadedData.__translateY || 0;
                        applyTransform();
                        hideEditPanel();
                        renderGraph();
                    } else {
                        alert('Arquivo JSON inválido.');
                    }
                } catch {
                    alert('Erro ao carregar JSON.');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // Zoom e pan
        let zoom = 1;
        let translateX = 0;
        let translateY = 0;
        let isPanning = false;
        let panStart = { x: 0, y: 0 };

        // Aplica transformações de zoom e pan
        function applyTransform() {
            // Aplica zoom e pan em tudo, inclusive nas linhas
            graphArea.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
            svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
            drawConnections();
        }

        // Mouse wheel para zoom
        graphArea.addEventListener('wheel', function (e) {
            if (e.ctrlKey) return; // deixa zoom do navegador funcionar normalmente
            e.preventDefault();
            const scaleAmount = 0.1;
            const oldZoom = zoom;
            if (e.deltaY < 0) {
                zoom = Math.min(zoom + scaleAmount, 3);
            } else {
                zoom = Math.max(zoom - scaleAmount, 0.2);
            }
            // Zoom centralizado no mouse
            const rect = graphArea.getBoundingClientRect();
            const mx = (e.clientX - rect.left - translateX) / oldZoom;
            const my = (e.clientY - rect.top - translateY) / oldZoom;
            translateX -= (zoom - oldZoom) * mx;
            translateY -= (zoom - oldZoom) * my;
            applyTransform();
        }, { passive: false });

        // Pan com mouse drag no fundo
        graphArea.addEventListener('mousedown', function (e) {
            if (e.target !== graphArea) return;
            isPanning = true;
            panStart.x = e.clientX - translateX;
            panStart.y = e.clientY - translateY;
            graphArea.style.cursor = 'move';
        });
        window.addEventListener('mousemove', function (e) {
            if (!isPanning) return;
            translateX = e.clientX - panStart.x;
            translateY = e.clientY - panStart.y;
            applyTransform();
        });
        window.addEventListener('mouseup', function () {
            isPanning = false;
            graphArea.style.cursor = '';
        });

        // Ao iniciar, aplica transformações
        applyTransform();

        renderGraph();

        photoInput.addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                if (selectedNode) {
                    selectedNode.photo = e.target.result;
                    if (!selectedNode.photoSize) selectedNode.photoSize = 80;
                    if (!selectedNode.nodeSize) selectedNode.nodeSize = 140;
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoSizeGroup.style.display = 'block';
                    photoSizeRange.value = selectedNode.photoSize;
                    nodeSizeGroup.style.display = 'block';
                    nodeSizeInput.value = selectedNode.nodeSize;
                    renderGraph();
                }
            };
            reader.readAsDataURL(file);
        });

        photoSizeRange.addEventListener('input', function () {
            if (selectedNode && selectedNode.photo) {
                selectedNode.photoSize = parseInt(this.value);
                renderGraph();
            }
        });

        nodeSizeInput.addEventListener('input', function () {
            if (selectedNode && selectedNode.photo) {
                let val = parseInt(this.value);
                if (isNaN(val) || val < 40) val = 40;
                if (val > 400) val = 400;
                selectedNode.nodeSize = val;
                this.value = val;
                renderGraph();
            }
        });
    </script>

</body>

</html>